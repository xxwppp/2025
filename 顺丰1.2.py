
import hashlib
import json
import os
import random
import time
from datetime import datetime, timedelta
from sys import exit
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning
from urllib.parse import unquote

# Á¶ÅÁî®ÂÆâÂÖ®ËØ∑Ê±ÇË≠¶Âëä
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
PROXY_API_URL = os.getenv('SF_PROXY_API_URL', '')  # ‰ªéÁéØÂ¢ÉÂèòÈáèËé∑Âèñ‰ª£ÁêÜAPIÂú∞ÂùÄ

def get_proxy():
    try:
        if not PROXY_API_URL:
            print('‚ö†Ô∏è Êú™ÈÖçÁΩÆ‰ª£ÁêÜAPIÂú∞ÂùÄÔºåÂ∞Ü‰∏ç‰ΩøÁî®‰ª£ÁêÜ')
            return None
            
        response = requests.get(PROXY_API_URL, timeout=10)
        if response.status_code == 200:
            proxy_text = response.text.strip()
            if ':' in proxy_text:
                proxy = f'http://{proxy_text}'
                return {
                    'http': proxy,
                    'https': proxy
                }
        print(f'‚ùå Ëé∑Âèñ‰ª£ÁêÜÂ§±Ë¥•: {response.text}')
        return None
    except Exception as e:
        print(f'‚ùå Ëé∑Âèñ‰ª£ÁêÜÂºÇÂ∏∏: {str(e)}')
        return None

send_msg = ''
one_msg = ''

def Log(cont=''):
    global send_msg, one_msg
    print(cont)
    if cont:
        one_msg += f'{cont}\n'
        send_msg += f'{cont}\n'

inviteId = ['']

class RUN:
    def __init__(self, info, index):
        global one_msg
        one_msg = ''
        split_info = info.split('@')
        url = split_info[0]
        len_split_info = len(split_info)
        last_info = split_info[len_split_info - 1]
        self.send_UID = None
        if len_split_info > 0 and "UID_" in last_info:
            self.send_UID = last_info
        self.index = index + 1

        self.proxy = get_proxy()
        if self.proxy:
            print(f"‚úÖ ÊàêÂäüËé∑Âèñ‰ª£ÁêÜ: {self.proxy['http']}")
        
        self.s = requests.session()
        self.s.verify = False
        if self.proxy:
            self.s.proxies = self.proxy
            
        self.headers = {
            'Host': 'mcs-mimp-web.sf-express.com',
            'upgrade-insecure-requests': '1',
            'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36 NetType/WIFI MicroMessenger/7.0.20.1781(0x6700143B) WindowsWechat(0x63090551) XWEB/6945 Flue',
            'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
            'sec-fetch-site': 'none',
            'sec-fetch-mode': 'navigate',
            'sec-fetch-user': '?1',
            'sec-fetch-dest': 'document',
            'accept-language': 'zh-CN,zh',
            'platform': 'MINI_PROGRAM',
        }
        
        self.login_res = self.login(url)
        self.all_logs = [] 
        self.today = datetime.now().strftime('%Y-%m-%d')
        self.member_day_black = False
        self.member_day_red_packet_drew_today = False
        self.member_day_red_packet_map = {}
        self.max_level = 8
        self.packet_threshold = 1 << (self.max_level - 1)
        self.totalPoint = 0

    def get_deviceId(self, characters='abcdef0123456789'):
        result = ''
        for char in 'xxxxxxxx-xxxx-xxxx':
            if char == 'x':
                result += random.choice(characters)
            elif char == 'X':
                result += random.choice(characters).upper()
            else:
                result += char
        return result

    def login(self, sfurl):
        try:
            decoded_url = unquote(sfurl)
            ress = self.s.get(decoded_url, headers=self.headers)
            self.user_id = self.s.cookies.get_dict().get('_login_user_id_', '')
            self.phone = self.s.cookies.get_dict().get('_login_mobile_', '')
            self.mobile = self.phone[:3] + "*" * 4 + self.phone[7:] if self.phone else ''
            
            if self.phone:
                Log(f'üë§ Ë¥¶Âè∑{self.index}:„Äê{self.mobile}„ÄëÁôªÈôÜÊàêÂäü')
                return True
            else:
                Log(f'‚ùå Ë¥¶Âè∑{self.index}Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•')
                return False
        except Exception as e:
            Log(f'‚ùå ÁôªÂΩïÂºÇÂ∏∏: {str(e)}')
            return False

    def getSign(self):
        timestamp = str(int(round(time.time() * 1000)))
        token = 'wwesldfs29aniversaryvdld29'
        sysCode = 'MCS-MIMP-CORE'
        data = f'token={token}&timestamp={timestamp}&sysCode={sysCode}'
        signature = hashlib.md5(data.encode()).hexdigest()
        data = {
            'sysCode': sysCode,
            'timestamp': timestamp,
            'signature': signature
        }
        self.headers.update(data)
        return data

    def do_request(self, url, data={}, req_type='post', max_retries=3):
        self.getSign()
        retry_count = 0
        
        while retry_count < max_retries:
            try:
                if req_type.lower() == 'get':
                    response = self.s.get(url, headers=self.headers, timeout=30)
                elif req_type.lower() == 'post':
                    response = self.s.post(url, headers=self.headers, json=data, timeout=30)
                else:
                    raise ValueError('Invalid req_type: %s' % req_type)
                    
                response.raise_for_status()
                
                try:
                    res = response.json()
                    return res
                except json.JSONDecodeError as e:
                    print(f'JSONËß£ÊûêÂ§±Ë¥•: {str(e)}, ÂìçÂ∫îÂÜÖÂÆπ: {response.text[:200]}')
                    retry_count += 1
                    if retry_count < max_retries:
                        print(f'Ê≠£Âú®ËøõË°åÁ¨¨{retry_count + 1}Ê¨°ÈáçËØï...')
                        time.sleep(2)
                        continue
                    return None
                    
            except requests.exceptions.RequestException as e:
                retry_count += 1
                if retry_count < max_retries:
                    print(f'ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÊ≠£Âú®ÂàáÊç¢‰ª£ÁêÜÈáçËØï ({retry_count}/{max_retries}): {str(e)}')
                    self.proxy = get_proxy()
                    if self.proxy:
                        print(f"‚úÖ ÊàêÂäüËé∑ÂèñÊñ∞‰ª£ÁêÜ: {self.proxy['http']}")
                        self.s.proxies = self.proxy
                    time.sleep(2)
                else:
                    print('ËØ∑Ê±ÇÊúÄÁªàÂ§±Ë¥•:', e)
                    return None
                
        return None

    def sign(self):
        print(f'üéØ ÂºÄÂßãÊâßË°åÁ≠æÂà∞')
        json_data = {"comeFrom": "vioin", "channelFrom": "WEIXIN"}
        url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~integralTaskSignPlusService~automaticSignFetchPackage'
        response = self.do_request(url, data=json_data)
        if response.get('success') == True:
            count_day = response.get('obj', {}).get('countDay', 0)
            if response.get('obj') and response['obj'].get('integralTaskSignPackageVOList'):
                packet_name = response["obj"]["integralTaskSignPackageVOList"][0]["packetName"]
                Log(f'‚ú® Á≠æÂà∞ÊàêÂäüÔºåËé∑Âæó„Äê{packet_name}„ÄëÔºåÊú¨Âë®Á¥ØËÆ°Á≠æÂà∞„Äê{count_day + 1}„ÄëÂ§©')
            else:
                Log(f'üìù ‰ªäÊó•Â∑≤Á≠æÂà∞ÔºåÊú¨Âë®Á¥ØËÆ°Á≠æÂà∞„Äê{count_day + 1}„ÄëÂ§©')
        else:
            print(f'‚ùå Á≠æÂà∞Â§±Ë¥•ÔºÅÂéüÂõ†Ôºö{response.get("errorMessage")}')

    def superWelfare_receiveRedPacket(self):
        print(f'üéÅ Ë∂ÖÂÄºÁ¶èÂà©Á≠æÂà∞')
        json_data = {
            'channel': 'czflqdlhbxcx'
        }
        url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberActLengthy~redPacketActivityService~superWelfare~receiveRedPacket'
        response = self.do_request(url, data=json_data)
        if response.get('success') == True:
            gift_list = response.get('obj', {}).get('giftList', [])
            if response.get('obj', {}).get('extraGiftList', []):
                gift_list.extend(response['obj']['extraGiftList'])
            gift_names = ', '.join([gift['giftName'] for gift in gift_list])
            receive_status = response.get('obj', {}).get('receiveStatus')
            status_message = 'È¢ÜÂèñÊàêÂäü' if receive_status == 1 else 'Â∑≤È¢ÜÂèñËøá'
            Log(f'üéâ Ë∂ÖÂÄºÁ¶èÂà©Á≠æÂà∞[{status_message}]: {gift_names}')
        else:
            error_message = response.get('errorMessage') or json.dumps(response) or 'Êó†ËøîÂõû'
            print(f'‚ùå Ë∂ÖÂÄºÁ¶èÂà©Á≠æÂà∞Â§±Ë¥•: {error_message}')

    def get_SignTaskList(self, END=False):
        if not END: print(f'üéØ ÂºÄÂßãËé∑ÂèñÁ≠æÂà∞‰ªªÂä°ÂàóË°®')
        json_data = {
            'channelType': '1',
            'deviceId': self.get_deviceId(),
        }
        url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~integralTaskStrategyService~queryPointTaskAndSignFromES'
        response = self.do_request(url, data=json_data)
        if response.get('success') == True and response.get('obj') != []:
            self.totalPoint = response["obj"]["totalPoint"]
            if END:
                Log(f'üí∞ ÂΩìÂâçÁßØÂàÜÔºö„Äê{self.totalPoint}„Äë')
                return
            Log(f'üí∞ ÊâßË°åÂâçÁßØÂàÜÔºö„Äê{self.totalPoint}„Äë')
            for task in response["obj"]["taskTitleLevels"]:
                self.taskId = task["taskId"]
                self.taskCode = task["taskCode"]
                self.strategyId = task["strategyId"]
                self.title = task["title"]
                status = task["status"]
                skip_title = ['Áî®Ë°å‰∏öÊ®°ÊùøÂØÑ‰ª∂‰∏ãÂçï', 'ÂéªÊñ∞Â¢û‰∏Ä‰∏™Êî∂‰ª∂ÂÅèÂ•Ω', 'ÂèÇ‰∏éÁßØÂàÜÊ¥ªÂä®']
                if status == 3:
                    print(f'‚ú® {self.title}-Â∑≤ÂÆåÊàê')
                    continue
                if self.title in skip_title:
                    print(f'‚è≠Ô∏è {self.title}-Ë∑≥Ëøá')
                    continue
                else:
                    # print("taskId:", taskId)
                    # print("taskCode:", taskCode)
                    # print("----------------------")
                    self.doTask()
                    time.sleep(3)
                self.receiveTask()

    def doTask(self):
        print(f'üéØ ÂºÄÂßãÂéªÂÆåÊàê„Äê{self.title}„Äë‰ªªÂä°')
        json_data = {
            'taskCode': self.taskCode,
        }
        url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonRoutePost/memberEs/taskRecord/finishTask'
        response = self.do_request(url, data=json_data)
        if response.get('success') == True:
            print(f'‚ú® „Äê{self.title}„Äë‰ªªÂä°-Â∑≤ÂÆåÊàê')
        else:
            print(f'‚ùå „Äê{self.title}„Äë‰ªªÂä°-{response.get("errorMessage")}')

    def receiveTask(self):
        print(f'üéÅ ÂºÄÂßãÈ¢ÜÂèñ„Äê{self.title}„Äë‰ªªÂä°Â•ñÂä±')
        json_data = {
            "strategyId": self.strategyId,
            "taskId": self.taskId,
            "taskCode": self.taskCode,
            "deviceId": self.get_deviceId()
        }
        url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~integralTaskStrategyService~fetchIntegral'
        response = self.do_request(url, data=json_data)
        if response.get('success') == True:
            print(f'‚ú® „Äê{self.title}„Äë‰ªªÂä°Â•ñÂä±È¢ÜÂèñÊàêÂäüÔºÅ')
        else:
            print(f'‚ùå „Äê{self.title}„Äë‰ªªÂä°-{response.get("errorMessage")}')


    def EAR_END_2023_TaskList(self):
        print('\nüé≠ ÂºÄÂßãÂπ¥ÁªàÈõÜÂç°‰ªªÂä°')
        json_data = {
            "activityCode": "YEAREND_2024",
            "channelType": "MINI_PROGRAM"
        }
        self.headers['channel'] = '24nzdb'
        self.headers['platform'] = 'MINI_PROGRAM'
        self.headers['syscode'] = 'MCS-MIMP-CORE'

        url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~activityTaskService~taskList'

        response = self.do_request(url, data=json_data)
        if response.get('success') == True:
            for item in response["obj"]:
                self.title = item["taskName"]
                self.taskType = item["taskType"]
                status = item["status"]
                if status == 3:
                    print(f'‚ú® „Äê{self.taskType}„Äë-Â∑≤ÂÆåÊàê')
                    continue
                if self.taskType == 'INTEGRAL_EXCHANGE':
                    print(f'‚ö†Ô∏è ÁßØÂàÜÂÖëÊç¢‰ªªÂä°ÊöÇ‰∏çÊîØÊåÅ')
                elif self.taskType == 'CLICK_MY_SETTING':
                    self.taskCode = item["taskCode"]
                    self.addDeliverPrefer()
                if "taskCode" in item:
                    self.taskCode = item["taskCode"]
                    self.doTask()
                    time.sleep(3)
                    self.receiveTask()
                else:
                    print(f'‚ö†Ô∏è ÊöÇÊó∂‰∏çÊîØÊåÅ„Äê{self.title}„Äë‰ªªÂä°')

    def addDeliverPrefer(self):
        print(f'>>>ÂºÄÂßã„Äê{self.title}„Äë‰ªªÂä°')
        json_data = {
            "country": "‰∏≠ÂõΩ",
            "countryCode": "A000086000",
            "province": "Âåó‰∫¨Â∏Ç",
            "provinceCode": "A110000000",
            "city": "Âåó‰∫¨Â∏Ç",
            "cityCode": "A111000000",
            "county": "‰∏úÂüéÂå∫",
            "countyCode": "A110101000",
            "address": "1Âè∑Ê•º1ÂçïÂÖÉ101",
            "latitude": "",
            "longitude": "",
            "memberId": "",
            "locationCode": "010",
            "zoneCode": "CN",
            "postCode": "",
            "takeWay": "7",
            "callBeforeDelivery": 'false',
            "deliverTag": "2,3,4,1",
            "deliverTagContent": "",
            "startDeliverTime": "",
            "selectCollection": 'false',
            "serviceName": "",
            "serviceCode": "",
            "serviceType": "",
            "serviceAddress": "",
            "serviceDistance": "",
            "serviceTime": "",
            "serviceTelephone": "",
            "channelCode": "RW11111",
            "taskId": self.taskId,
            "extJson": "{\"noDeliverDetail\":[]}"
        }
        url = 'https://ucmp.sf-express.com/cx-wechat-member/member/deliveryPreference/addDeliverPrefer'
        response = self.do_request(url, data=json_data)
        if response.get('success') == True:
            print('Êñ∞Â¢û‰∏Ä‰∏™Êî∂‰ª∂ÂÅèÂ•ΩÔºåÊàêÂäü')
        else:
            print(f'>„Äê{self.title}„Äë‰ªªÂä°-{response.get("errorMessage")}')

    def member_day_index(self):
        print('üé≠ ‰ºöÂëòÊó•Ê¥ªÂä®')
        try:
            invite_user_id = random.choice([invite for invite in inviteId if invite != self.user_id])
            payload = {'inviteUserId': invite_user_id}
            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~memberDayIndexService~index'

            response = self.do_request(url, data=payload)
            if response.get('success'):
                lottery_num = response.get('obj', {}).get('lotteryNum', 0)
                can_receive_invite_award = response.get('obj', {}).get('canReceiveInviteAward', False)
                if can_receive_invite_award:
                    self.member_day_receive_invite_award(invite_user_id)
                self.member_day_red_packet_status()
                Log(f'üéÅ ‰ºöÂëòÊó•ÂèØ‰ª•ÊäΩÂ•ñ{lottery_num}Ê¨°')
                for _ in range(lottery_num):
                    self.member_day_lottery()
                if self.member_day_black:
                    return
                self.member_day_task_list()
                if self.member_day_black:
                    return
                self.member_day_red_packet_status()
            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                Log(f'üìù Êü•ËØ¢‰ºöÂëòÊó•Â§±Ë¥•: {error_message}')
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_receive_invite_award(self, invite_user_id):
        try:
            payload = {'inviteUserId': invite_user_id}

            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~memberDayIndexService~receiveInviteAward'

            response = self.do_request(url, payload)
            if response.get('success'):
                product_name = response.get('obj', {}).get('productName', 'Á©∫Ê∞î')
                Log(f'üéÅ ‰ºöÂëòÊó•Â•ñÂä±: {product_name}')
            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                Log(f'üìù È¢ÜÂèñ‰ºöÂëòÊó•Â•ñÂä±Â§±Ë¥•: {error_message}')
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_lottery(self):
        try:
            payload = {}
            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~memberDayLotteryService~lottery'

            response = self.do_request(url, payload)
            if response.get('success'):
                product_name = response.get('obj', {}).get('productName', 'Á©∫Ê∞î')
                Log(f'üéÅ ‰ºöÂëòÊó•ÊäΩÂ•ñ: {product_name}')
            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                Log(f'üìù ‰ºöÂëòÊó•ÊäΩÂ•ñÂ§±Ë¥•: {error_message}')
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_task_list(self):
        try:
            payload = {'activityCode': 'MEMBER_DAY', 'channelType': 'MINI_PROGRAM'}
            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~activityTaskService~taskList'

            response = self.do_request(url, payload)
            if response.get('success'):
                task_list = response.get('obj', [])
                for task in task_list:
                    if task['status'] == 1:
                        if self.member_day_black:
                            return
                        self.member_day_fetch_mix_task_reward(task)
                for task in task_list:
                    if task['status'] == 2:
                        if self.member_day_black:
                            return
                        if task['taskType'] in ['SEND_SUCCESS', 'INVITEFRIENDS_PARTAKE_ACTIVITY', 'OPEN_SVIP',
                                                'OPEN_NEW_EXPRESS_CARD', 'OPEN_FAMILY_CARD', 'CHARGE_NEW_EXPRESS_CARD',
                                                'INTEGRAL_EXCHANGE']:
                            pass
                        else:
                            for _ in range(task['restFinishTime']):
                                if self.member_day_black:
                                    return
                                self.member_day_finish_task(task)
            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                Log('üìù Êü•ËØ¢‰ºöÂëòÊó•‰ªªÂä°Â§±Ë¥•: ' + error_message)
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_finish_task(self, task):
        try:
            payload = {'taskCode': task['taskCode']}

            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberEs~taskRecord~finishTask'

            response = self.do_request(url, payload)
            if response.get('success'):
                Log('üìù ÂÆåÊàê‰ºöÂëòÊó•‰ªªÂä°[' + task['taskName'] + ']ÊàêÂäü')
                self.member_day_fetch_mix_task_reward(task)
            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                Log('üìù ÂÆåÊàê‰ºöÂëòÊó•‰ªªÂä°[' + task['taskName'] + ']Â§±Ë¥•: ' + error_message)
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_fetch_mix_task_reward(self, task):
        try:
            payload = {'taskType': task['taskType'], 'activityCode': 'MEMBER_DAY', 'channelType': 'MINI_PROGRAM'}

            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~activityTaskService~fetchMixTaskReward'

            response = self.do_request(url, payload)
            if response.get('success'):
                Log('üéÅ È¢ÜÂèñ‰ºöÂëòÊó•‰ªªÂä°[' + task['taskName'] + ']Â•ñÂä±ÊàêÂäü')
            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                Log('üìù È¢ÜÂèñ‰ºöÂëòÊó•‰ªªÂä°[' + task['taskName'] + ']Â•ñÂä±Â§±Ë¥•: ' + error_message)
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_receive_red_packet(self, hour):
        try:
            payload = {'receiveHour': hour}
            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~memberDayTaskService~receiveRedPacket'

            response = self.do_request(url, payload)
            if response.get('success'):
                print(f'üéÅ ‰ºöÂëòÊó•È¢ÜÂèñ{hour}ÁÇπÁ∫¢ÂåÖÊàêÂäü')
            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                print(f'üìù ‰ºöÂëòÊó•È¢ÜÂèñ{hour}ÁÇπÁ∫¢ÂåÖÂ§±Ë¥•: {error_message}')
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_red_packet_status(self):
        try:
            payload = {}
            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~memberDayPacketService~redPacketStatus'
            response = self.do_request(url, payload)
            if response.get('success'):
                packet_list = response.get('obj', {}).get('packetList', [])
                for packet in packet_list:
                    self.member_day_red_packet_map[packet['level']] = packet['count']

                for level in range(1, self.max_level):
                    count = self.member_day_red_packet_map.get(level, 0)
                    while count >= 2:
                        self.member_day_red_packet_merge(level)
                        count -= 2
                packet_summary = []
                remaining_needed = 0

                for level, count in self.member_day_red_packet_map.items():
                    if count == 0:
                        continue
                    packet_summary.append(f"[{level}Á∫ß]X{count}")
                    int_level = int(level)
                    if int_level < self.max_level:
                        remaining_needed += 1 << (int_level - 1)

                Log("üìù ‰ºöÂëòÊó•ÂêàÊàêÂàóË°®: " + ", ".join(packet_summary))

                if self.member_day_red_packet_map.get(self.max_level):
                    Log(f"üéÅ ‰ºöÂëòÊó•Â∑≤Êã•Êúâ[{self.max_level}Á∫ß]Á∫¢ÂåÖX{self.member_day_red_packet_map[self.max_level]}")
                    self.member_day_red_packet_draw(self.max_level)
                else:
                    remaining = self.packet_threshold - remaining_needed
                    Log(f"üìù ‰ºöÂëòÊó•Ë∑ùÁ¶ª[{self.max_level}Á∫ß]Á∫¢ÂåÖËøòÂ∑Æ: [1Á∫ß]Á∫¢ÂåÖX{remaining}")

            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                Log(f'üìù Êü•ËØ¢‰ºöÂëòÊó•ÂêàÊàêÂ§±Ë¥•: {error_message}')
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_red_packet_merge(self, level):
        try:
            # for key,level in enumerate(self.member_day_red_packet_map):
            #     pass
            payload = {'level': level, 'num': 2}
            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~memberDayPacketService~redPacketMerge'

            response = self.do_request(url, payload)
            if response.get('success'):
                Log(f'üéÅ ‰ºöÂëòÊó•ÂêàÊàê: [{level}Á∫ß]Á∫¢ÂåÖX2 -> [{level + 1}Á∫ß]Á∫¢ÂåÖ')
                self.member_day_red_packet_map[level] -= 2
                if not self.member_day_red_packet_map.get(level + 1):
                    self.member_day_red_packet_map[level + 1] = 0
                self.member_day_red_packet_map[level + 1] += 1
            else:
                error_message = response.get('errorMessage', 'Êó†ËøîÂõû')
                Log(f'üìù ‰ºöÂëòÊó•ÂêàÊàê‰∏§‰∏™[{level}Á∫ß]Á∫¢ÂåÖÂ§±Ë¥•: {error_message}')
                if 'Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®' in error_message:
                    self.member_day_black = True
                    Log('üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß')
        except Exception as e:
            print(e)

    def member_day_red_packet_draw(self, level):
        try:
            payload = {'level': str(level)}
            url = 'https://mcs-mimp-web.sf-express.com/mcs-mimp/commonPost/~memberNonactivity~memberDayPacketService~redPacketDraw'
            response = self.do_request(url, payload)
            if response and response.get('success'):
                coupon_names = [item['couponName'] for item in response.get('obj', [])] or []

                Log(f"üéÅ ‰ºöÂëòÊó•ÊèêÂèñ[{level}Á∫ß]Á∫¢ÂåÖ: {', '.join(coupon_names) or 'Á©∫Ê∞î'}")
            else:
                error_message = response.get('errorMessage') if response else "Êó†ËøîÂõû"
                Log(f"üìù ‰ºöÂëòÊó•ÊèêÂèñ[{level}Á∫ß]Á∫¢ÂåÖÂ§±Ë¥•: {error_message}")
                if "Ê≤°ÊúâËµÑÊ†ºÂèÇ‰∏éÊ¥ªÂä®" in error_message:
                    self.memberDay_black = True
                    print("üìù ‰ºöÂëòÊó•‰ªªÂä°È£éÊéß")
        except Exception as e:
            print(e)


    def main(self):
        global one_msg
        wait_time = random.randint(1000, 3000) / 1000.0  
        time.sleep(wait_time)  
        one_msg = ''
        if not self.login_res: return False

        self.sign()
        self.superWelfare_receiveRedPacket()
        self.get_SignTaskList()
        self.get_SignTaskList(True)

        current_date = datetime.now().day
        if 26 <= current_date <= 28:
            self.member_day_index()
        else:
            print('‚è∞ Êú™Âà∞ÊåáÂÆöÊó∂Èó¥‰∏çÊâßË°å‰ºöÂëòÊó•‰ªªÂä°\n==================================\n')

        return True

def main():
    ENV_NAME = 'sfsyUrl'
    local_version = '2025.10.08'
    token = os.getenv(ENV_NAME)
    if not token:
        print(f"‚ùå Êú™ÊâæÂà∞ÁéØÂ¢ÉÂèòÈáè {ENV_NAME}ÔºåËØ∑Ê£ÄÊü•ÈÖçÁΩÆ")
        return
    tokens = token.split('&')
    tokens = [t.strip() for t in tokens if t.strip()]
    if len(tokens) == 0:
        print(f"‚ùå ÁéØÂ¢ÉÂèòÈáè {ENV_NAME} ‰∏∫Á©∫ÊàñÊ†ºÂºèÈîôËØØ")
        return
        
    print(f"==================================")
    print(f"üéâ ÂëÜÂëÜÁ≤â‰∏ùÂêéÊè¥‰ºöÔºö996374999")
    print(f"üöö È°∫‰∏∞ÈÄüËøêËÑöÊú¨ v{local_version}")
    print(f"üì± ÂÖ±Ëé∑ÂèñÂà∞{len(tokens)}‰∏™Ë¥¶Âè∑")
    print(f"üò£ ‰øÆÊîπBy:ÂëÜÂëÜÂëÜÂëÜ")
    print(f"==================================")
    
    for index, infos in enumerate(tokens):
        run_result = RUN(infos, index).main()
        if not run_result: continue

if __name__ == '__main__':
    main()
# ÂΩìÂâçËÑöÊú¨Êù•Ëá™‰∫éhttp://script.345yun.cnËÑöÊú¨Â∫ì‰∏ãËΩΩÔºÅ